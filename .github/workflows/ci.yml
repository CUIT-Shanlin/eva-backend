name: Build and Publish

on:
  push:
    branches:
      - master
      - master-test
  workflow_dispatch:

env:
  EVA_VERSION: 2.07-SNAPSHOT
  EVA_TEST_VERSION: 2.19
  PORTAINER_UPDATE_TEST_URL: ${{ secrets.PORTAINER_UPDATE_TEST_URL }}
  SERVER_ARTIFACT: eva-server-jar
  PROD_IMAGE: ${{ format('{0}/eva-system/eva-server', secrets.HARBOR_HOST) }}
  TEST_IMAGE: ${{ format('{0}/eva-system/eva-server-test', secrets.HARBOR_HOST) }}

jobs:
  build:
    name: Build Artifact
    runs-on: shanlin
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven
          server-username: 'LystranG'
          server-password: ${{ secrets.PACKAGE_TOKEN }}
      - name: Package server JAR
        run: mvn package -Dmaven.test.skip=true
      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SERVER_ARTIFACT }}
          path: start/target/eva-server.jar
          if-no-files-found: error

  publish:
    name: Publish Production Image
    runs-on: shanlin
    needs: build
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SERVER_ARTIFACT }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - name: Build production image
        run: |
          docker pull ${PROD_IMAGE}:latest || true
          docker build \
            --cache-from ${PROD_IMAGE}:latest \
            --build-arg JVMOPTIONS="-Dspring.profiles.active=prod" \
            -t eva-server:${EVA_VERSION} .
      - name: Tag and push production image
        run: |
          docker tag eva-server:${EVA_VERSION} ${PROD_IMAGE}:${EVA_VERSION}
          docker push ${PROD_IMAGE}:${EVA_VERSION}
          docker tag eva-server:${EVA_VERSION} ${PROD_IMAGE}:latest
          docker push ${PROD_IMAGE}:latest

  publish-test:
    name: Publish Test Image
    runs-on: shanlin
    needs: build
    if: github.ref == 'refs/heads/master-test'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SERVER_ARTIFACT }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      - name: Build test image
        run: |
          docker pull ${TEST_IMAGE}:latest || true
          docker build \
            --cache-from ${TEST_IMAGE}:latest \
            --build-arg JVMOPTIONS="-Dspring.profiles.active=debug" \
            -t eva-server-test:${EVA_TEST_VERSION} .
      - name: Tag and push test image
        run: |
          docker tag eva-server-test:${EVA_TEST_VERSION} ${TEST_IMAGE}:${EVA_TEST_VERSION}
          docker push ${TEST_IMAGE}:${EVA_TEST_VERSION}
          docker tag eva-server-test:${EVA_TEST_VERSION} ${TEST_IMAGE}:latest
          docker push ${TEST_IMAGE}:latest

  recreate-test:
    name: Trigger Portainer Update (Test)
    runs-on: shanlin
    needs:
      - build
      - publish-test
    if: github.ref == 'refs/heads/master-test'
    steps:
      - name: Call Portainer webhook
        run: |
          if [ -z "${PORTAINER_UPDATE_TEST_URL}" ]; then
            echo "PORTAINER_UPDATE_TEST_URL is not set." >&2
            exit 1
          fi
          curl -X POST "${PORTAINER_UPDATE_TEST_URL}"
